var es = require("event-stream");
var gutil = require("gulp-util");
var fs = require("fs");

function gulpCommonJS(){
    var data = fs.readFileSync(__dirname + "/template.js");
    var template = gutil.template(data.toString("utf8"));

    var wrap = function(file, callback){
        if (file.isBuffer()) {
            var opts = {
                contents: file.contents.toString("utf8"),
                file: file
            };

            file.contents = new Buffer(template(opts));
        }

        if (file.isStream()) {
            var through = es.through();
            var wait = es.wait(function(error, contents){
                var opts = {
                    contents: contents,
                    file: file
                };
                through.write(template(opts));
            });
            file.contents.pipe(wait);
            file.contents = through;
        }
        
        return callback(null, file);
    };

    return es.map(wrap);
}

module.exports = gulpCommonJS;