var fs = require("fs");
var es = require("event-stream");
var should = require("should");
var gulpCommonJS = require("../");
var gutil = require("gulp-util");

describe("gulp-commonjs", function(){
    var expected = fs.readFileSync("test/fixtures/expected.js", { encoding: "utf8" });

    it("should produce expected file via buffer", function (done) {
        var srcFile = new gutil.File({
            path: "test/fixtures/test.js",
            cwd: "test/",
            base: "test/fixtures",
            contents: fs.readFileSync("test/fixtures/test.js")
        });
        var stream = gulpCommonJS();

        stream.on("error", function (error) {
            should.exist(error);
            done(error);
        });

        stream.on("data", function(file){
            file.isBuffer().should.equal(true);

            var content = file.contents.toString("utf8");

            content.should.be.exactly(expected);

            done();
        });

        stream.write(srcFile);
        stream.end();
    });

    it("should produce expected file via stream", function (done) {
        var srcFile = new gutil.File({
            path: "test/fixtures/test.js",
            cwd: "test/",
            base: "test/fixtures",
            contents: fs.createReadStream("test/fixtures/test.js")
        });
        var stream = gulpCommonJS();

        stream.on("error", function (error) {
            should.exist(error);
            done(error);
        });

        stream.on("data", function(file){
            file.isStream().should.equal(true);

            file.contents.pipe(es.map(function(content, callback){
                content.should.be.exactly(expected);

                done();
            }));
        });

        stream.write(srcFile);
        stream.end();
    });
});